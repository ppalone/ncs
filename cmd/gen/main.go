package main

import (
	"fmt"
	"go/format"
	"net/http"
	"os"
	"strings"

	"github.com/PuerkitoBio/goquery"
)

func main() {
	resp, err := http.Get("https://ncs.io/music-search")
	if err != nil {
		panic(err)
	}
	defer resp.Body.Close()

	doc, err := goquery.NewDocumentFromReader(resp.Body)
	if err != nil {
		panic(err)
	}

	genres := doc.Find("select[name=\"genre\"] option")
	if genres.Length() == 0 {
		panic("no genres found")
	}

	garr := make([][]string, 0)
	genres.Each(func(i int, s *goquery.Selection) {
		id := s.AttrOr("value", "")
		if id == "" {
			return
		}

		t := strings.FieldsFunc(s.Text(), func(r rune) bool {
			return r == ' ' || r == '-' || r == '&'
		})

		genre := capitalize(t)

		garr = append(garr, []string{genre, s.Text(), id})
	})

	err = write("Genre", garr)
	if err != nil {
		panic(err)
	}

	moods := doc.Find("select[name=\"mood\"] option")
	if genres.Length() == 0 {
		panic("no moods found")
	}

	marr := make([][]string, 0)
	tmp := make(map[string]struct{})
	moods.Each(func(i int, s *goquery.Selection) {
		id := s.AttrOr("value", "")
		if id == "" {
			return
		}

		t := strings.FieldsFunc(s.Text(), func(r rune) bool {
			return r == ' ' || r == '-' || r == '&'
		})

		mood := capitalize(t)
		if _, ok := tmp[mood]; ok {
			mood += "Lower"
		}

		marr = append(marr, []string{mood, s.Text(), id})
		tmp[mood] = struct{}{}
	})

	err = write("Mood", marr)
	if err != nil {
		panic(err)
	}
}

func capitalize(arr []string) string {
	t := ""
	for _, e := range arr {
		if e == "" {
			continue
		}

		t += strings.ToUpper(e[:1]) + e[1:]
	}
	return t
}

func write(file string, data [][]string) error {
	f := "// Code generated by go generate; DO NOT EDIT.\npackage ncs\n\n"
	f += fmt.Sprintf("type %s string\n\n", file)

	f += "const (\n"
	for _, a := range data {
		f += fmt.Sprintf("\t%s %s = \"%s\"\n", a[0], file, a[1])
	}
	f += ")\n\n"

	f += fmt.Sprintf("var %sMap = map[%s]int{\n", file, file)
	for _, a := range data {
		f += fmt.Sprintf("\t%s: %s,\n", a[0], a[2])
	}
	f += "}\n\n"

	formatted, err := format.Source([]byte(f))
	if err != nil {
		return err
	}

	return os.WriteFile(fmt.Sprintf("%s.go", strings.ToLower(file)), formatted, 0644)
}
